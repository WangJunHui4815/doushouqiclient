
{"version":3,"sources":["../../../../../assets/sprite/controller/assets/sprite/controller/gameCtrl.js"],"names":["userInfoCtrl","require","GameEndCtrl","cc","Class","extends","Component","properties","roomPanel","Node","roomId","Label","userPanel","getReadyBtn","Button","gamePanel","endPanel","win","lose","chatPanel","userInfo","Prefab","tips","_userInfoPos","_userInfo","onLoad","v2","initHandlers","string","js","formatStr","vv","gameNetMgr","loader","loadRes","SpriteAtlas","err","atlas","log","emjioAtlas","start","console","onDestroy","releaseRes","dataEventHandler","node","self","on","data","userId","userid","userMgr","ready","active","emit","showGamePanel","hideGamePanel","newUserComein","results","showEndPanel","sender","content","index","str","runAction","sequence","delayTime","hide","getComponent","showResult","res","score","showWinAnimction","showLoesAnimction","m_animSprite","find","m_animation","Animation","play","showChatPanel","hideChatPanel","getReady","net","send","onCardClicked","event","cardID","getIsBanker","hideCard","guessCard","cardId","initUserInfo","seatInfo","info","instantiate","userInfoPos","seatindex","parent","setPosition","showUserInfo"],"mappings":"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","file":"gameCtrl.js","sourceRoot":"../../../../../assets/sprite/controller","sourcesContent":["const userInfoCtrl = require(\"userInfoCtrl\")\nconst GameEndCtrl = require(\"gameEndCtrl\")\n// const Tool = require(\"Tools\")\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        roomPanel: cc.Node,\n        roomId: cc.Label,\n        userPanel: cc.Node,\n        getReadyBtn: cc.Button,\n        gamePanel: cc.Node,\n        endPanel: cc.Node,\n        win:cc.Node,\n        lose:cc.Node,\n        chatPanel: cc.Node,\n        userInfo: cc.Prefab,\n        tips: cc.Label,\n        _userInfoPos: [],\n        _userInfo: null,\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n\n    onLoad () {\n        this._userInfoPos = [cc.v2(0, 245),\n                             cc.v2(-544, -245), cc.v2(-544,0), cc.v2(-544, 245), \n                             cc.v2(-255, 245), cc.v2(255, 245), cc.v2(255, 245), cc.v2(544, 245),\n                             cc.v2(544, 245), cc.v2(544, 0), cc.v2(544, -245)]\n        this.initHandlers()\n        this.roomId.string = cc.js.formatStr(\"房间号: %s\", cc.vv.gameNetMgr.roomId)\n        this._userInfo = {}\n\n        cc.loader.loadRes(\"chat/emoji_action_texture\", cc.SpriteAtlas, function (err, atlas) {\n            cc.log(\"chat\")\n            cc.vv.emjioAtlas = atlas\n        })\n    },\n\n    start() {\n        console.log(\"start\")\n    },\n\n    onDestroy () {\n        cc.log(\"gameCtrl ondestroy\")\n        cc.loader.releaseRes(\"chat/emoji_action_texture\")\n    },\n\n    // 注册监听事件\n    initHandlers: function () {\n        cc.vv.gameNetMgr.dataEventHandler = this.node;\n        var self = this;\n\n        this.node.on(\"user_state_changed\", function (data) {\n            let userId = data.userid\n            if (userId == cc.vv.userMgr.userId && data.ready) {\n                self.getReadyBtn.node.active = false\n            }\n            self._userInfo[userId].emit(\"user_state\", data.ready)\n        })\n\n        this.node.on('game_begin', function (data) {\n            // self.onGameBeign();\n        });\n\n        // 庄家开始藏牌\n        this.node.on('can_hide_card', function () {\n            console.log(\"can_hide_card\")\n            self.showGamePanel(1)\n        });\n        \n        this.node.on('hide_card_success', function (data) {\n            self.hideGamePanel()\n        });\n\n        // 闲家开始猜牌\n        this.node.on('can_guess_card', function (data) {\n            self.showGamePanel(0)\n        });\n\n        this.node.on('guess_card_result', function (data) {\n            self.hideGamePanel()\n        });\n\n        this.node.on('new_user_comein', function (data) {\n            self.newUserComein(data)\n        });\n\n        // game_end\n        this.node.on('game_over', function (results) {\n            self.showEndPanel(results)\n        });\n\n        // 聊天\n        this.node.on('chat_push', function (data) {\n            cc.log(\"gamectrl chat\")\n            cc.log(data)\n            let userId = data.sender\n            self._userInfo[userId].emit(\"show_chat_info\", data.content)\n        });\n\n        this.node.on('emoji_push', function (data) {\n            cc.log(\"gamectrl emoji\")\n            cc.log(data)\n            let userId = data.sender\n            self._userInfo[userId].emit(\"show_emoji_info\", data.content)\n        });\n    },\n\n    showGamePanel: function (index) {\n        this.gamePanel.active = true\n        let str = index == 1 ? \"庄家开始藏牌\" : \"闲家猜牌\"\n        this.tips.string = str\n        this.tips.node.active = true\n        this.tips.node.runAction(cc.sequence(cc.delayTime(1), cc.hide()))\n    },\n\n    hideGamePanel: function () {\n        this.gamePanel.active = false\n    },\n\n    showEndPanel: function (results) {\n        \n        this.endPanel.active = true;\n        \n        this.endPanel.getComponent(GameEndCtrl).showResult(results);\n        for (let res of results){\n            if(res.userId == cc.vv.userMgr.userId){\n                if(res.score > 0){\n                    this.showWinAnimction();\n                }else if(res.score < 0){\n                    this.showLoesAnimction();\n                }\n            }\n        }\n        \n    },\n\n    showWinAnimction: function (){\n        var m_animSprite = cc.find(\"Canvas/endPanel/win\");\n        m_animSprite.active = true;\n        var m_animation = m_animSprite.getComponent(cc.Animation);\n        m_animation.play(\"win\");\n    },\n    showLoesAnimction: function (){\n        var m_animSprite = cc.find(\"Canvas/endPanel/lose\");\n        m_animSprite.active = true;\n        var m_animation = m_animSprite.getComponent(cc.Animation);\n        m_animation.play(\"lose\");\n    },\n\n    showChatPanel: function() {\n        this.chatPanel.active = true\n    },\n    \n    hideChatPanel: function() {\n        this.chatPanel.active = false\n    },\n\n    getReady: function () {\n        cc.vv.net.send('ready');\n    },\n\n    onCardClicked: function (event, cardID) {\n        console.log(\"onCardClicked\")\n        console.log(event)\n        console.log(cardID)\n        if (cc.vv.userMgr.getIsBanker()) {\n            this.hideCard(cardID)\n        }\n        else {\n            this.guessCard(cardID)\n        }\n    },\n\n    hideCard: function (cardId) {\n        console.log(\"hidecard\")\n        console.log(cardId)\n        if (cardId && cardId > 0) {\n            console.log(\"cangpai\")\n            cc.vv.net.send('cangpai', cardId);\n        }\n    },\n\n    guessCard: function (cardId) {\n        console.log(\"guessCard\")\n        console.log(cardId)\n        if (cardId && cardId > 0) {\n            console.log(\"caipai\")\n            cc.vv.net.send('caipai', {\"p1\": cardId, \"p2\": 10, \"p3\": 0});\n        }\n    },\n\n    initUserInfo (seatInfo) {\n        for (let info of seatInfo) {\n            let userId = info.userid\n            if (userId > 0) {\n                let userInfo = cc.instantiate(this.userInfo)\n                let userInfoPos = this._userInfoPos[info.seatindex]\n                userInfo.parent = this.userPanel\n                userInfo.setPosition(userInfoPos)\n                userInfo.getComponent(userInfoCtrl).showUserInfo(info)\n\n                this._userInfo[userId] = userInfo\n            }\n        }\n    },\n\n    newUserComein: function (data) {\n        let userId = data.userid\n        if (userId > 0) {\n            let userInfo = cc.instantiate(this.userInfo)\n            let userInfoPos = this._userInfoPos[data.seatindex]\n            userInfo.parent = this.userPanel\n            userInfo.setPosition(userInfoPos)\n            userInfo.getComponent(userInfoCtrl).showUserInfo(data)\n            this._userInfo[userId] = userInfo\n\n            cc.log(\"_userinfo\")\n            cc.log(this._userInfo)\n        }\n    }\n\n    // update (dt) {},\n});\n"]}

