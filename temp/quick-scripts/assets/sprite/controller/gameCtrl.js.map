{"version":3,"sources":["gameCtrl.js"],"names":["userInfoCtrl","require","GameEndCtrl","cc","Class","extends","Component","properties","roomPanel","Node","roomId","Label","userPanel","getReadyBtn","Button","gamePanel","endPanel","chatPanel","userInfo","Prefab","tips","_userInfoPos","_userInfo","onLoad","v2","initHandlers","string","js","formatStr","vv","gameNetMgr","loader","loadRes","SpriteAtlas","err","atlas","log","emjioAtlas","start","console","onDestroy","releaseRes","dataEventHandler","node","self","on","data","userId","userid","userMgr","ready","active","emit","showGamePanel","hideGamePanel","newUserComein","results","showEndPanel","sender","content","index","str","runAction","sequence","delayTime","hide","getComponent","showResult","showChatPanel","hideChatPanel","getReady","net","send","onCardClicked","event","cardID","getIsBanker","hideCard","guessCard","cardId","initUserInfo","seatInfo","info","instantiate","userInfoPos","seatindex","parent","setPosition","showUserInfo"],"mappings":"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","file":"gameCtrl.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\sprite\\controller","sourcesContent":["const userInfoCtrl = require(\"userInfoCtrl\")\r\nconst GameEndCtrl = require(\"gameEndCtrl\")\r\n// const Tool = require(\"Tools\")\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        roomPanel: cc.Node,\r\n        roomId: cc.Label,\r\n        userPanel: cc.Node,\r\n        getReadyBtn: cc.Button,\r\n        gamePanel: cc.Node,\r\n        endPanel: cc.Node,\r\n        chatPanel: cc.Node,\r\n        userInfo: cc.Prefab,\r\n        tips: cc.Label,\r\n        _userInfoPos: [],\r\n        _userInfo: null,\r\n    },\r\n\r\n    // LIFE-CYCLE CALLBACKS:\r\n\r\n    onLoad () {\r\n        this._userInfoPos = [cc.v2(0, 245),\r\n                             cc.v2(-544, -245), cc.v2(-544,0), cc.v2(-544, 245), \r\n                             cc.v2(-255, 245), cc.v2(255, 245), cc.v2(255, 245), cc.v2(544, 245),\r\n                             cc.v2(544, 245), cc.v2(544, 0), cc.v2(544, -245)]\r\n        this.initHandlers()\r\n        this.roomId.string = cc.js.formatStr(\"房间号: %s\", cc.vv.gameNetMgr.roomId)\r\n        this._userInfo = {}\r\n\r\n        cc.loader.loadRes(\"chat/emoji_action_texture\", cc.SpriteAtlas, function (err, atlas) {\r\n            cc.log(\"chat\")\r\n            cc.vv.emjioAtlas = atlas\r\n        })\r\n    },\r\n\r\n    start() {\r\n        console.log(\"start\")\r\n    },\r\n\r\n    onDestroy () {\r\n        cc.log(\"gameCtrl ondestroy\")\r\n        cc.loader.releaseRes(\"chat/emoji_action_texture\")\r\n    },\r\n\r\n    // 注册监听事件\r\n    initHandlers: function () {\r\n        cc.vv.gameNetMgr.dataEventHandler = this.node;\r\n        var self = this;\r\n\r\n        this.node.on(\"user_state_changed\", function (data) {\r\n            let userId = data.userid\r\n            if (userId == cc.vv.userMgr.userId && data.ready) {\r\n                self.getReadyBtn.node.active = false\r\n            }\r\n            self._userInfo[userId].emit(\"user_state\", data.ready)\r\n        })\r\n\r\n        this.node.on('game_begin', function (data) {\r\n            // self.onGameBeign();\r\n        });\r\n\r\n        // 庄家开始藏牌\r\n        this.node.on('can_hide_card', function () {\r\n            console.log(\"can_hide_card\")\r\n            self.showGamePanel(1)\r\n        });\r\n        \r\n        this.node.on('hide_card_success', function (data) {\r\n            self.hideGamePanel()\r\n        });\r\n\r\n        // 闲家开始猜牌\r\n        this.node.on('can_guess_card', function (data) {\r\n            self.showGamePanel(0)\r\n        });\r\n\r\n        this.node.on('guess_card_result', function (data) {\r\n            self.hideGamePanel()\r\n        });\r\n\r\n        this.node.on('new_user_comein', function (data) {\r\n            self.newUserComein(data)\r\n        });\r\n\r\n        // game_end\r\n        this.node.on('game_over', function (results) {\r\n            self.showEndPanel(results)\r\n        });\r\n\r\n        // 聊天\r\n        this.node.on('chat_push', function (data) {\r\n            cc.log(\"gamectrl chat\")\r\n            cc.log(data)\r\n            let userId = data.sender\r\n            self._userInfo[userId].emit(\"show_chat_info\", data.content)\r\n        });\r\n\r\n        this.node.on('emoji_push', function (data) {\r\n            cc.log(\"gamectrl emoji\")\r\n            cc.log(data)\r\n            let userId = data.sender\r\n            self._userInfo[userId].emit(\"show_emoji_info\", data.content)\r\n        });\r\n    },\r\n\r\n    showGamePanel: function (index) {\r\n        this.gamePanel.active = true\r\n        let str = index == 1 ? \"庄家开始藏牌\" : \"闲家猜牌\"\r\n        this.tips.string = str\r\n        this.tips.node.active = true\r\n        this.tips.node.runAction(cc.sequence(cc.delayTime(1), cc.hide()))\r\n    },\r\n\r\n    hideGamePanel: function () {\r\n        this.gamePanel.active = false\r\n    },\r\n\r\n    showEndPanel: function (results) {\r\n        this.endPanel.active = true\r\n        this.endPanel.getComponent(GameEndCtrl).showResult(results)\r\n    },\r\n\r\n    showChatPanel: function() {\r\n        this.chatPanel.active = true\r\n    },\r\n    \r\n    hideChatPanel: function() {\r\n        this.chatPanel.active = false\r\n    },\r\n\r\n    getReady: function () {\r\n        cc.vv.net.send('ready');\r\n    },\r\n\r\n    onCardClicked: function (event, cardID) {\r\n        console.log(\"onCardClicked\")\r\n        console.log(event)\r\n        console.log(cardID)\r\n        if (cc.vv.userMgr.getIsBanker()) {\r\n            this.hideCard(cardID)\r\n        }\r\n        else {\r\n            this.guessCard(cardID)\r\n        }\r\n    },\r\n\r\n    hideCard: function (cardId) {\r\n        console.log(\"hidecard\")\r\n        console.log(cardId)\r\n        if (cardId && cardId > 0) {\r\n            console.log(\"cangpai\")\r\n            cc.vv.net.send('cangpai', cardId);\r\n        }\r\n    },\r\n\r\n    guessCard: function (cardId) {\r\n        console.log(\"guessCard\")\r\n        console.log(cardId)\r\n        if (cardId && cardId > 0) {\r\n            console.log(\"caipai\")\r\n            cc.vv.net.send('caipai', {\"p1\": cardId, \"p2\": 10, \"p3\": 0});\r\n        }\r\n    },\r\n\r\n    initUserInfo (seatInfo) {\r\n        for (let info of seatInfo) {\r\n            let userId = info.userid\r\n            if (userId > 0) {\r\n                let userInfo = cc.instantiate(this.userInfo)\r\n                let userInfoPos = this._userInfoPos[info.seatindex]\r\n                userInfo.parent = this.userPanel\r\n                userInfo.setPosition(userInfoPos)\r\n                userInfo.getComponent(userInfoCtrl).showUserInfo(info)\r\n\r\n                this._userInfo[userId] = userInfo\r\n            }\r\n        }\r\n    },\r\n\r\n    newUserComein: function (data) {\r\n        let userId = data.userid\r\n        if (userId > 0) {\r\n            let userInfo = cc.instantiate(this.userInfo)\r\n            let userInfoPos = this._userInfoPos[data.seatindex]\r\n            userInfo.parent = this.userPanel\r\n            userInfo.setPosition(userInfoPos)\r\n            userInfo.getComponent(userInfoCtrl).showUserInfo(data)\r\n            this._userInfo[userId] = userInfo\r\n\r\n            cc.log(\"_userinfo\")\r\n            cc.log(this._userInfo)\r\n        }\r\n    }\r\n\r\n    // update (dt) {},\r\n});\r\n"]}