{"version":3,"sources":["Net.js"],"names":["window","io","require","Global","cc","Class","extends","Component","statics","ip","sio","isPinging","fnDisconnect","handlers","connect","fnConnect","fnError","self","opts","on","data","connected","console","log","close","key","value","startHearbeat","lastRecieveTime","Date","now","setInterval","ping","send","event","JSON","stringify","emit","disconnect","addHandler","fn","handler","parse"],"mappings":"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","file":"Net.js","sourceRoot":"../../../../../assets/sprite/Net","sourcesContent":["if (window.io == null) {\n    window.io = require(\"socket-io\");\n}\n\nvar Global = cc.Class({\n    extends: cc.Component,\n    statics: {\n        ip: \"\",\n        sio: null,\n        isPinging: false,\n        fnDisconnect: null,\n        handlers: {},\n\n        connect: function (fnConnect, fnError) {\n            const self = this;\n\n            var opts = {\n                'reconnection': false,\n                'force new connection': true,\n                'transports': ['websocket', 'polling']\n            }\n            this.sio = window.io.connect(this.ip, opts);\n\n            this.sio.on('connect', function (data) {\n                self.sio.connected = true;\n                fnConnect(data);\n            });\n            this.sio.on('disconnect', function (data) {\n                console.log(\"disconnect\");\n                self.sio.connected = false;\n                self.close();\n            });\n            this.sio.on('reconnect', function () {\n                console.log('reconnection');\n            });\n            this.sio.on('connect_failed', function () {\n                console.log('connect_failed');\n                fnError()\n            });\n\n            for (var key in this.handlers) {\n                var value = this.handlers[key];\n                if (typeof (value) == \"function\") {\n                    if (key == 'disconnect') {\n                        this.fnDisconnect = value;\n                    }\n                    else {\n                        this.sio.on(key, value);\n                    }\n                }\n            }\n\n            this.startHearbeat();\n        },\n\n        startHearbeat: function () {\n            this.sio.on('game_pong', function () {\n                console.log('game_pong');\n                self.lastRecieveTime = Date.now();\n            });\n            this.lastRecieveTime = Date.now();\n            var self = this;\n            console.log(1);\n            if (!self.isPinging) {\n                console.log(2);\n                self.isPinging = true;\n                setInterval(function () {\n                    console.log(3);\n                    if (self.sio) {\n                        console.log(4);\n                        if (Date.now() - self.lastRecieveTime > 10000) {\n                            self.close();\n                        }\n                        else {\n                            self.ping();\n                        }\n                    }\n                }, 5000);\n            }\n        },\n\n        ping: function () {\n            this.send('game_ping');\n        },\n\n        send: function (event, data) {\n            if (this.sio.connected) {\n                if (data != null && (typeof (data) == \"object\")) {\n                    data = JSON.stringify(data);\n                    //console.log(data);              \n                }\n                this.sio.emit(event, data);\n            }\n        },\n        \n        close: function () {\n            console.log('close');\n            if (this.sio && this.sio.connected) {\n                this.sio.connected = false;\n                this.sio.disconnect();\n                this.sio = null;\n            }\n            if (this.fnDisconnect) {\n                this.fnDisconnect();\n                this.fnDisconnect = null;\n            }\n        },\n        \n        addHandler: function (event, fn) {\n            if (this.handlers[event]) {\n                console.log(\"event:\" + event + \"' handler has been registered.\");\n                return;\n            }\n\n            var handler = function (data) {\n                //console.log(event + \"(\" + typeof(data) + \"):\" + (data? data.toString():\"null\"));\n                if (event != \"disconnect\" && typeof (data) == \"string\") {\n                    data = JSON.parse(data);\n                }\n                fn(data);\n            };\n\n            this.handlers[event] = handler;\n            if (this.sio) {\n                // console.log(\"register:function \" + event);\n                this.sio.on(event, handler);\n            }\n        },\n    }\n});"]}