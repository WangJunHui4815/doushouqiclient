{"version":3,"sources":["gameCtrl.js"],"names":["userInfoCtrl","require","GameEndCtrl","cc","Class","extends","Component","properties","roomPanel","Node","roomId","Label","userPanel","getReadyBtn","Button","gamePanel","endPanel","win","lose","chatPanel","userInfo","Prefab","tips","_userInfoPos","_userInfo","onLoad","v2","initHandlers","string","js","formatStr","vv","gameNetMgr","loader","loadRes","SpriteAtlas","err","atlas","log","emjioAtlas","start","console","onDestroy","releaseRes","dataEventHandler","node","self","on","data","userId","userid","userMgr","ready","active","emit","showGamePanel","hideGamePanel","newUserComein","results","showEndPanel","sender","content","index","str","runAction","sequence","delayTime","hide","getComponent","showResult","showWinAnimction","m_animSprite","find","m_animation","Animation","play","showLoesAnimction","showChatPanel","hideChatPanel","getReady","net","send","onCardClicked","event","cardID","getIsBanker","hideCard","guessCard","cardId","initUserInfo","seatInfo","info","instantiate","userInfoPos","seatindex","parent","setPosition","showUserInfo"],"mappings":"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","file":"gameCtrl.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\sprite\\controller","sourcesContent":["const userInfoCtrl = require(\"userInfoCtrl\")\r\nconst GameEndCtrl = require(\"gameEndCtrl\")\r\n// const Tool = require(\"Tools\")\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        roomPanel: cc.Node,\r\n        roomId: cc.Label,\r\n        userPanel: cc.Node,\r\n        getReadyBtn: cc.Button,\r\n        gamePanel: cc.Node,\r\n        endPanel: cc.Node,\r\n        win:cc.Node,\r\n        lose:cc.Node,\r\n        chatPanel: cc.Node,\r\n        userInfo: cc.Prefab,\r\n        tips: cc.Label,\r\n        _userInfoPos: [],\r\n        _userInfo: null,\r\n    },\r\n\r\n    // LIFE-CYCLE CALLBACKS:\r\n\r\n    onLoad () {\r\n        this._userInfoPos = [cc.v2(0, 245),\r\n                             cc.v2(-544, -245), cc.v2(-544,0), cc.v2(-544, 245), \r\n                             cc.v2(-255, 245), cc.v2(255, 245), cc.v2(255, 245), cc.v2(544, 245),\r\n                             cc.v2(544, 245), cc.v2(544, 0), cc.v2(544, -245)]\r\n        this.initHandlers()\r\n        this.roomId.string = cc.js.formatStr(\"房间号: %s\", cc.vv.gameNetMgr.roomId)\r\n        this._userInfo = {}\r\n\r\n        cc.loader.loadRes(\"chat/emoji_action_texture\", cc.SpriteAtlas, function (err, atlas) {\r\n            cc.log(\"chat\")\r\n            cc.vv.emjioAtlas = atlas\r\n        })\r\n    },\r\n\r\n    start() {\r\n        console.log(\"start\")\r\n    },\r\n\r\n    onDestroy () {\r\n        cc.log(\"gameCtrl ondestroy\")\r\n        cc.loader.releaseRes(\"chat/emoji_action_texture\")\r\n    },\r\n\r\n    // 注册监听事件\r\n    initHandlers: function () {\r\n        cc.vv.gameNetMgr.dataEventHandler = this.node;\r\n        var self = this;\r\n\r\n        this.node.on(\"user_state_changed\", function (data) {\r\n            let userId = data.userid\r\n            if (userId == cc.vv.userMgr.userId && data.ready) {\r\n                self.getReadyBtn.node.active = false\r\n            }\r\n            self._userInfo[userId].emit(\"user_state\", data.ready)\r\n        })\r\n\r\n        this.node.on('game_begin', function (data) {\r\n            // self.onGameBeign();\r\n        });\r\n\r\n        // 庄家开始藏牌\r\n        this.node.on('can_hide_card', function () {\r\n            console.log(\"can_hide_card\")\r\n            self.showGamePanel(1)\r\n        });\r\n        \r\n        this.node.on('hide_card_success', function (data) {\r\n            self.hideGamePanel()\r\n        });\r\n\r\n        // 闲家开始猜牌\r\n        this.node.on('can_guess_card', function (data) {\r\n            self.showGamePanel(0)\r\n        });\r\n\r\n        this.node.on('guess_card_result', function (data) {\r\n            self.hideGamePanel()\r\n        });\r\n\r\n        this.node.on('new_user_comein', function (data) {\r\n            self.newUserComein(data)\r\n        });\r\n\r\n        // game_end\r\n        this.node.on('game_over', function (results) {\r\n            self.showEndPanel(results)\r\n        });\r\n\r\n        // 聊天\r\n        this.node.on('chat_push', function (data) {\r\n            cc.log(\"gamectrl chat\")\r\n            cc.log(data)\r\n            let userId = data.sender\r\n            self._userInfo[userId].emit(\"show_chat_info\", data.content)\r\n        });\r\n\r\n        this.node.on('emoji_push', function (data) {\r\n            cc.log(\"gamectrl emoji\")\r\n            cc.log(data)\r\n            let userId = data.sender\r\n            self._userInfo[userId].emit(\"show_emoji_info\", data.content)\r\n        });\r\n    },\r\n\r\n    showGamePanel: function (index) {\r\n        this.gamePanel.active = true\r\n        let str = index == 1 ? \"庄家开始藏牌\" : \"闲家猜牌\"\r\n        this.tips.string = str\r\n        this.tips.node.active = true\r\n        this.tips.node.runAction(cc.sequence(cc.delayTime(1), cc.hide()))\r\n    },\r\n\r\n    hideGamePanel: function () {\r\n        this.gamePanel.active = false\r\n    },\r\n\r\n    showEndPanel: function (results) {\r\n        console.log(\"show  end panel 1\");\r\n        this.endPanel.active = true;\r\n        console.log(\"show  end panel 2\");\r\n        this.endPanel.getComponent(GameEndCtrl).showResult(results);\r\n        this.showWinAnimction();\r\n        console.log(\"show  end panel 3\");\r\n    },\r\n\r\n    showWinAnimction: function (){\r\n        var m_animSprite = cc.find(\"Canvas/endPanel/win\");\r\n        var m_animation = m_animSprite.getComponent(cc.Animation);\r\n        m_animation.play(win);\r\n    },\r\n    showLoesAnimction: function (){\r\n        var m_animSprite = cc.find(\"Canvas/endPanel/lose\");\r\n        var m_animation = m_animSprite.getComponent(cc.Animation);\r\n        m_animation.play(lose);\r\n    },\r\n\r\n    showChatPanel: function() {\r\n        this.chatPanel.active = true\r\n    },\r\n    \r\n    hideChatPanel: function() {\r\n        this.chatPanel.active = false\r\n    },\r\n\r\n    getReady: function () {\r\n        cc.vv.net.send('ready');\r\n    },\r\n\r\n    onCardClicked: function (event, cardID) {\r\n        console.log(\"onCardClicked\")\r\n        console.log(event)\r\n        console.log(cardID)\r\n        if (cc.vv.userMgr.getIsBanker()) {\r\n            this.hideCard(cardID)\r\n        }\r\n        else {\r\n            this.guessCard(cardID)\r\n        }\r\n    },\r\n\r\n    hideCard: function (cardId) {\r\n        console.log(\"hidecard\")\r\n        console.log(cardId)\r\n        if (cardId && cardId > 0) {\r\n            console.log(\"cangpai\")\r\n            cc.vv.net.send('cangpai', cardId);\r\n        }\r\n    },\r\n\r\n    guessCard: function (cardId) {\r\n        console.log(\"guessCard\")\r\n        console.log(cardId)\r\n        if (cardId && cardId > 0) {\r\n            console.log(\"caipai\")\r\n            cc.vv.net.send('caipai', {\"p1\": cardId, \"p2\": 10, \"p3\": 0});\r\n        }\r\n    },\r\n\r\n    initUserInfo (seatInfo) {\r\n        for (let info of seatInfo) {\r\n            let userId = info.userid\r\n            if (userId > 0) {\r\n                let userInfo = cc.instantiate(this.userInfo)\r\n                let userInfoPos = this._userInfoPos[info.seatindex]\r\n                userInfo.parent = this.userPanel\r\n                userInfo.setPosition(userInfoPos)\r\n                userInfo.getComponent(userInfoCtrl).showUserInfo(info)\r\n\r\n                this._userInfo[userId] = userInfo\r\n            }\r\n        }\r\n    },\r\n\r\n    newUserComein: function (data) {\r\n        let userId = data.userid\r\n        if (userId > 0) {\r\n            let userInfo = cc.instantiate(this.userInfo)\r\n            let userInfoPos = this._userInfoPos[data.seatindex]\r\n            userInfo.parent = this.userPanel\r\n            userInfo.setPosition(userInfoPos)\r\n            userInfo.getComponent(userInfoCtrl).showUserInfo(data)\r\n            this._userInfo[userId] = userInfo\r\n\r\n            cc.log(\"_userinfo\")\r\n            cc.log(this._userInfo)\r\n        }\r\n    }\r\n\r\n    // update (dt) {},\r\n});\r\n"]}